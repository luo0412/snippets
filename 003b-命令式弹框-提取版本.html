<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‘½ä»¤å¼å¼¹æ¡† - éšè—åŠŸèƒ½æµ‹è¯•</title>
  <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/ant-design-vue/1.7.8/antd.min.css">
  <script src="https://cdn.bootcdn.net/ajax/libs/vue/2.7.16/vue.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/ant-design-vue/1.7.8/antd.min.js"></script>
  
  <script src="./modal-manager/modal-manager.js"></script>
  <script src="./modal-manager/modal-components.js"></script>
  
  <style>
    .demo-container {
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .btn-group {
      margin-bottom: 20px;
      padding: 15px;
      background: #f0f8ff;
      border-radius: 8px;
    }
    .btn-group .ant-btn {
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .status-panel {
      padding: 15px;
      background: #f5f5f5;
      border-radius: 6px;
    }
    .tips {
      color: #1890ff;
      margin-bottom: 10px;
      padding: 10px;
      background: #e6f7ff;
      border-radius: 4px;
    }
    .log-panel {
      margin-top: 10px;
      padding: 10px;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="app" class="demo-container">
    <h2 style="color: #1890ff; margin-bottom: 20px;">å‘½ä»¤å¼å¼¹æ¡† - éšè—åŠŸèƒ½æµ‹è¯•</h2>
    
    <!-- æç¤ºè¯´æ˜ -->
    <div class="tips">
      ğŸ“Œ æµ‹è¯•æµç¨‹ï¼š<br>
      1. ç‚¹å‡»ã€Œæ‰“å¼€å¯éšè—æ¨¡æ€æ¡†ã€â†’ æ¨¡æ€æ¡†å†…ç‚¹å‡»ã€Œä»…éšè—ï¼ˆä¸é”€æ¯ï¼‰ã€<br>
      2. ç‚¹å‡»ã€Œæ‰‹åŠ¨éšè—æ¨¡æ€æ¡†ã€â†’ æµ‹è¯•APIéšè—åŠŸèƒ½<br>
      3. ç‚¹å‡»ã€Œæ˜¾ç¤ºéšè—çš„æ¨¡æ€æ¡†ã€â†’ æ¢å¤æ˜¾ç¤º<br>
      4. æœ€åå¯ç‚¹å‡»ã€Œé”€æ¯éšè—çš„æ¨¡æ€æ¡†ã€å½»åº•åˆ é™¤
    </div>
    
    <!-- æŒ‰é’®åŒºåŸŸ -->
    <div class="btn-group">
      <a-button type="default" @click="openSimpleModal">A. æ‰“å¼€æ™®é€šæ¨¡æ€æ¡†</a-button>
      <a-button type="dashed" @click="openCallbackModal">B. æ‰“å¼€å¸¦å›è°ƒæ¨¡æ€æ¡†</a-button>
      
      <a-button type="primary" @click="openHideableModal">1. æ‰“å¼€å¯éšè—æ¨¡æ€æ¡†</a-button>
      <a-button type="purple" @click="manualHideModal" :disabled="!hiddenModalId">2. æ‰‹åŠ¨éšè—æ¨¡æ€æ¡†</a-button>
      <a-button type="success" @click="showHiddenModal" :disabled="!hiddenModalId">3. æ˜¾ç¤ºéšè—çš„æ¨¡æ€æ¡†</a-button>
      <a-button type="danger" @click="destroyHiddenModal" :disabled="!hiddenModalId">4. é”€æ¯éšè—çš„æ¨¡æ€æ¡†</a-button>
      <a-button type="default" @click="closeAll">5. å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†</a-button>
    </div>
    
    <!-- çŠ¶æ€å±•ç¤º -->
    <div class="status-panel">
      <h4>å½“å‰çŠ¶æ€ï¼š</h4>
      <div>
        <div>ğŸ” å·²æ‰“å¼€çš„æ¨¡æ€æ¡†ï¼š
          <a-tag v-for="modal in openModals" :key="modal.id" color="blue" style="margin: 0 5px 5px 0;">
            {{ modal.title }} (ID: {{ modal.id }})
          </a-tag>
          <span v-if="openModals.length === 0">æ— </span>
        </div>
        <div style="margin-top: 8px;">ğŸ”’ å·²éšè—çš„æ¨¡æ€æ¡†IDï¼š{{ hiddenModalId || 'æ— ' }}</div>
      </div>
      
      <h4 style="margin-top: 10px;">æ“ä½œæ—¥å¿—ï¼š</h4>
      <div class="log-panel">
        <div v-for="(log, idx) in logs" :key="idx" style="line-height: 1.6;">
          [{{ log.time }}] {{ log.msg }}
        </div>
        <div v-if="logs.length === 0" style="color: #999;">æš‚æ— æ“ä½œ</div>
      </div>
    </div>
  </div>

  <script>
    new Vue({
      el: '#app',
      data() {
        return {
          openModals: [],
          logs: [],
          hiddenModalId: '', // å­˜å‚¨éšè—çš„æ¨¡æ€æ¡†ID
          timer: null
        };
      },
      mounted() {
        this.addLog('é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œå¯æµ‹è¯•æ¨¡æ€æ¡†éšè—åŠŸèƒ½');
        this.timer = setInterval(() => {
          this.openModals = ModalManager.getOpenModals();
        }, 500);
      },
      beforeDestroy() {
        clearInterval(this.timer);
        ModalManager.closeAllModals();
      },
      methods: {
        addLog(msg) {
          this.logs.unshift({
            time: new Date().toLocaleTimeString(),
            msg: msg
          });
          if (this.logs.length > 20) this.logs.pop();
        },

        // ========== ç¤ºä¾‹ï¼šæ‰“å¼€æ™®é€šæ¨¡æ€æ¡† ==========
        async openSimpleModal() {
          this.addLog('æ‰“å¼€æ™®é€šç¡®è®¤æ¨¡æ€æ¡†ç¤ºä¾‹');
          const [err, res] = await ModalManager.toOpenModal('ConfirmModal', {
            message: 'è¿™æ˜¯ä¸€ä¸ªæ™®é€šç¡®è®¤æ¨¡æ€æ¡†ï¼ˆç¤ºä¾‹ï¼‰',
            modalKey: null
          });

          if (err) {
            this.addLog(err.isCanceled ? 'ç”¨æˆ·å–æ¶ˆæ™®é€šæ¨¡æ€æ¡†' : `æ‰“å¼€å¤±è´¥ï¼š${err.message}`);
            this.$message[err.isCanceled ? 'info' : 'error'](err.isCanceled ? 'æ“ä½œå·²å–æ¶ˆ' : 'æ‰“å¼€å¤±è´¥');
          } else {
            this.addLog(`æ™®é€šç¡®è®¤æ¨¡æ€æ¡†å·²å…³é—­å¹¶è¿”å›ï¼š${JSON.stringify(res.data || res)}`);
          }
        },

        // ========== ç¤ºä¾‹ï¼šæ‰“å¼€å¸¦å›è°ƒ/è¿”å›æ•°æ®çš„æ¨¡æ€æ¡† ==========
        async openCallbackModal() {
          this.addLog('æ‰“å¼€å¸¦å›è°ƒçš„æ¨¡æ€æ¡†ï¼ˆç­‰å¾…è¿”å›æ•°æ®ï¼‰');
          const [err, res] = await ModalManager.toOpenModal('CustomModal', {
            title: 'å¸¦å›è°ƒæ¨¡æ€æ¡†',
            initValue: 'è¯·åœ¨æ¨¡æ€æ¡†å†…æäº¤æ•°æ®',
            modalKey: null
          });

          if (err) {
            this.addLog(err.isCanceled ? 'ç”¨æˆ·å–æ¶ˆå›è°ƒæ¨¡æ€æ¡†' : `æ‰“å¼€å¤±è´¥ï¼š${err.message}`);
            this.$message[err.isCanceled ? 'info' : 'error'](err.isCanceled ? 'æ“ä½œå·²å–æ¶ˆ' : 'æ‰“å¼€å¤±è´¥');
          } else {
            const returned = (res && (res.data || res)) || res;
            this.addLog(`å›è°ƒæ¨¡æ€æ¡†å·²å…³é—­å¹¶è¿”å›ï¼š${JSON.stringify(returned)}`);
            this.$message.success('æ”¶åˆ°æ¨¡æ€æ¡†è¿”å›æ•°æ®');
          }
        },

        // ========== 1. æ‰“å¼€å¯éšè—çš„æ¨¡æ€æ¡† ==========
        async openHideableModal() {
          this.addLog('æ‰“å¼€æ”¯æŒä»…éšè—çš„æ¨¡æ€æ¡†ï¼ˆä¸ä¼šè‡ªåŠ¨é”€æ¯ï¼‰');
          const [err, res] = await ModalManager.toOpenModal('CustomModal', {
            title: 'å¯éšè—æµ‹è¯•æ¨¡æ€æ¡†',
            allowHide: true, // å¼€å¯ä»…éšè—åŠŸèƒ½
            initValue: 'æµ‹è¯•éšè—åŠŸèƒ½',
            modalKey: 'hideable-modal' // å›ºå®škeyï¼Œé˜²æ­¢é‡å¤åˆ›å»º
          });
          
          if (err) {
            this.addLog(err.isCanceled ? 'ç”¨æˆ·å–æ¶ˆæ‰“å¼€' : `æ‰“å¼€å¤±è´¥ï¼š${err.message}`);
            this.$message[err.isCanceled ? 'info' : 'error'](err.isCanceled ? 'æ“ä½œå·²å–æ¶ˆ' : 'æ‰“å¼€å¤±è´¥');
          } else {
            this.addLog(`æ¨¡æ€æ¡†å·²æ‰“å¼€ï¼ŒIDï¼š${res.modalId}`);
            this.hiddenModalId = res.modalId; // è®°å½•IDï¼Œä¾›åç»­æ“ä½œ
          }
        },

        // ========== 2. æ‰‹åŠ¨è°ƒç”¨éšè—API ==========
        manualHideModal() {
          if (!this.hiddenModalId) {
            this.$message.warning('è¯·å…ˆæ‰“å¼€æ¨¡æ€æ¡†');
            return;
          }
          
          this.addLog(`æ‰‹åŠ¨è°ƒç”¨hideModal APIï¼Œéšè—IDï¼š${this.hiddenModalId}`);
          const success = ModalManager.hideModal(this.hiddenModalId);
          
          if (success) {
            this.addLog(`æ¨¡æ€æ¡† ${this.hiddenModalId} å·²é€šè¿‡APIéšè—`);
            this.$message.success('æ¨¡æ€æ¡†å·²éšè—ï¼ˆæœªé”€æ¯ï¼‰');
          } else {
            this.addLog(`éšè—å¤±è´¥ï¼Œæ¨¡æ€æ¡†å¯èƒ½å·²é”€æ¯`);
            this.$message.error('éšè—å¤±è´¥');
            this.hiddenModalId = '';
          }
        },

        // ========== 3. æ˜¾ç¤ºéšè—çš„æ¨¡æ€æ¡† ==========
        showHiddenModal() {
          if (!this.hiddenModalId) {
            this.$message.warning('æ²¡æœ‰å·²éšè—çš„æ¨¡æ€æ¡†');
            return;
          }
          
          this.addLog(`è°ƒç”¨showModal APIï¼Œæ˜¾ç¤ºIDï¼š${this.hiddenModalId}`);
          const success = ModalManager.showModal(this.hiddenModalId);
          
          if (success) {
            this.addLog(`æ¨¡æ€æ¡† ${this.hiddenModalId} å·²é‡æ–°æ˜¾ç¤º`);
            this.$message.success('æ¨¡æ€æ¡†å·²æ˜¾ç¤º');
          } else {
            this.addLog(`æ˜¾ç¤ºå¤±è´¥ï¼Œæ¨¡æ€æ¡†å¯èƒ½å·²é”€æ¯`);
            this.$message.error('æ˜¾ç¤ºå¤±è´¥');
            this.hiddenModalId = '';
          }
        },

        // ========== 4. é”€æ¯éšè—çš„æ¨¡æ€æ¡† ==========
        destroyHiddenModal() {
          if (!this.hiddenModalId) {
            this.$message.warning('æ²¡æœ‰å·²éšè—çš„æ¨¡æ€æ¡†');
            return;
          }
          
          this.addLog(`è°ƒç”¨destroyModal APIï¼Œé”€æ¯IDï¼š${this.hiddenModalId}`);
          const success = ModalManager.destroyModal(this.hiddenModalId);
          
          if (success) {
            this.addLog(`æ¨¡æ€æ¡† ${this.hiddenModalId} å·²å½»åº•é”€æ¯`);
            this.$message.success('æ¨¡æ€æ¡†å·²é”€æ¯');
            this.hiddenModalId = ''; // æ¸…ç©ºID
          } else {
            this.addLog(`é”€æ¯å¤±è´¥`);
            this.$message.error('é”€æ¯å¤±è´¥');
          }
        },

        // ========== 5. å…³é—­æ‰€æœ‰æ¨¡æ€æ¡† ==========
        closeAll() {
          this.addLog('å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†ï¼ˆåŒ…æ‹¬éšè—çš„ï¼‰');
          ModalManager.closeAllModals();
          this.hiddenModalId = '';
          this.$message.info('æ‰€æœ‰æ¨¡æ€æ¡†å·²å…³é—­/é”€æ¯');
        }
      }
    });
  </script>
</body>
</html>