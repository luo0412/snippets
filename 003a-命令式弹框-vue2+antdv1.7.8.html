<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vue2 + Ant Design Vue 弹窗管理器 (内嵌弹框 + 隐藏/销毁分离)</title>
  <!-- 引入 Ant Design Vue 样式 -->
  <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/ant-design-vue/1.7.8/antd.min.css">
  <!-- 引入 Vue 2 -->
  <script src="https://cdn.bootcdn.net/ajax/libs/vue/2.7.16/vue.min.js"></script>
  <!-- 引入 Ant Design Vue (兼容 Vue2 的 1.x 版本) -->
  <script src="https://cdn.bootcdn.net/ajax/libs/ant-design-vue/1.7.8/antd.min.js"></script>
  <!-- 引入 pubsub.js -->
  <script src="https://cdn.bootcdn.net/ajax/libs/pubsub-js/1.9.4/pubsub.min.js"></script>
  <!-- 引入 Prism.js 用于语法高亮 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</head>
<body>
  <div id="app">
    <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
      <h2>Vue2 + Ant Design Vue 弹窗管理器 (内嵌弹框 + 隐藏/销毁分离)</h2>
      <div style="margin-bottom: 20px;">
        <a-button type="primary" @click="openCustomDialog">打开自定义弹窗</a-button>
        <a-button type="danger" @click="openConfirmDialog" style="margin-left: 10px;">打开确认弹窗</a-button>
        <a-button type="dashed" @click="openByComponentName" style="margin-left: 10px;">通过组件名打开弹窗</a-button>
        <a-button type="warning" @click="openByPubsub" style="margin-left: 10px;">通过Pubsub打开弹窗</a-button>
        <a-button type="default" @click="closeAllDialogs" style="margin-left: 10px;">关闭所有弹窗</a-button>
      </div>

      <h3>当前打开的弹窗:</h3>
      <div style="margin-bottom: 20px;">
        <span v-if="openDialogs.length === 0">无</span>
        <a-tag 
          v-for="dialog in openDialogs" 
          :key="dialog.id" 
          color="blue"
        >
          {{ dialog.title }} (ID: {{ dialog.id }}, 类型: {{ dialog.type }})
        </a-tag>
      </div>

      <h3>调用方法示例：</h3>
      <div class="code-examples">
        <div class="example-section">
          <h4>1. 打开弹窗（Await-to-js风格）：</h4>
          <pre><code class="language-javascript">const [err, result] = await DialogManager.toOpenDialog(
  GlobalDialogComponents.CustomDialog,
  { 
    title: 'AntV 自定义弹窗',
    dialogKey: 'custom_dialog' // 包含在props中，防重复打开
  }
);

if (err) {
  // 弹窗被取消或发生错误
  if (err.isCanceled) {
    console.log('弹窗被取消：', err);
  } else {
    console.error('弹窗打开失败：', err);
  }
} else {
  // 弹窗成功确认
  console.log('弹窗确认返回数据：', result.data);
}</code></pre>
        </div>

        <div class="example-section">
          <h4>2. 隐藏/销毁弹窗：</h4>
          <pre><code class="language-javascript">// 隐藏弹窗（仅隐藏，不销毁实例）
DialogManager.hideDialog('dialog_id');

// 销毁弹窗（完全销毁，释放内存）
DialogManager.destroyDialog('dialog_id');

// 或者通过pubsub
DialogManager.pubsubHideDialog('dialog_id');
DialogManager.pubsubDestroyDialog('dialog_id');</code></pre>
        </div>

        <div class="example-section">
          <h4>3. 内嵌弹窗示例（在弹窗中打开另一个弹窗）：</h4>
          <pre><code class="language-javascript">export default {
  // 在弹窗组件内部打开另一个弹窗
  methods: {
    async openNestedDialog() {
      // 在当前弹窗中打开另一个弹窗
      const [err, result] = await DialogManager.toOpenDialog(
        'NestedDialog', 
        { 
          title: '内嵌弹窗',
          dialogKey: 'nested_dialog_' + this.dialogId,
          parentDialogId: this.dialogId // 传递父弹窗ID
        }
      );
      
      if (!err) {
        console.log('内嵌弹窗确认：', result.data);
      }
    }
  }
}</code></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== 全局注册的弹窗组件集合 ==========
    const GlobalDialogComponents = {
      // 自定义内容弹窗
      CustomDialog: {
        props: {
          title: {
            type: String,
            default: '自定义弹窗'
          },
          visible: {
            type: Boolean,
            default: false
          },
          dialogId: {
            type: String,
            default: ''
          },
          resolve: {
            type: Function,
            required: true
          },
          reject: {
            type: Function,
            required: true
          }
        },
        template: `
          <a-modal
            :title="title"
            :visible="visible"
            :maskClosable="false"
            :closable="true"
            width="400px"
            @cancel="handleCancel"
            @ok="handleConfirm"
          >
            <div>这是自定义弹窗（ID：{{dialogId}}）</div>
            <a-input 
              v-model="inputValue" 
              placeholder="请输入内容" 
              style="margin-top: 10px;"
            />
            <div style="margin-top: 10px;">
              <a-button type="primary" size="small" @click="openNestedDialog">打开内嵌弹窗</a-button>
              <a-button type="dashed" size="small" @click="hideCurrentDialog" style="margin-left: 8px;">隐藏当前弹窗</a-button>
            </div>
          </a-modal>
        `,
        data() {
          return {
            inputValue: ''
          };
        },
        methods: {
          handleCancel() {
            console.log('CustomDialog handleCancel called');
            // 首先隐藏弹窗
            this.visible = false;
            // 然后执行reject回调，标记为取消
            this.reject({ 
              reason: '用户关闭/取消弹窗', 
              dialogId: this.dialogId,
              isCanceled: true
            });
            // 最后关闭弹窗
            DialogManager.destroyDialog(this.dialogId);
          },
          handleConfirm() {
            console.log('CustomDialog handleConfirm called');
            // 首先隐藏弹窗
            this.visible = false;
            // 然后执行resolve回调
            this.resolve({ inputValue: this.inputValue, dialogId: this.dialogId });
            // 最后关闭弹窗
            DialogManager.destroyDialog(this.dialogId);
          },
          async openNestedDialog() {
            // 在当前弹窗中打开另一个弹窗
            const [err, result] = await DialogManager.toOpenDialog(
              'NestedDialog', 
              { 
                title: '内嵌弹窗',
                dialogKey: 'nested_dialog_' + this.dialogId,
                parentDialogId: this.dialogId // 传递父弹窗ID
              }
            );
            
            if (!err) {
              console.log('内嵌弹窗确认：', result.data);
              this.$message.success(`内嵌弹窗返回: ${JSON.stringify(result.data)}`);
            }
          },
          hideCurrentDialog() {
            // 隐藏当前弹窗
            DialogManager.hideDialog(this.dialogId);
            this.$message.info('当前弹窗已隐藏');
          }
        },
        // 组件销毁前清理数据
        beforeDestroy() {
          this.inputValue = '';
        }
      },
      
      // 确认弹窗
      ConfirmDialog: {
        props: {
          message: {
            type: String,
            default: '确定要执行此操作吗？'
          },
          visible: {
            type: Boolean,
            default: false
          },
          dialogId: {
            type: String,
            default: ''
          },
          resolve: {
            type: Function,
            required: true
          },
          reject: {
            type: Function,
            required: true
          }
        },
        template: `
          <a-modal
            title="确认操作"
            :visible="visible"
            :maskClosable="false"
            :closable="false"
            width="300px"
            @cancel="handleCancel"
            @ok="handleConfirm"
          >
            <div style="color: #666;">{{ message }}</div>
            <div style="margin-top: 10px;">
              <a-button type="primary" size="small" @click="openNestedConfirm">打开内嵌确认弹窗</a-button>
            </div>
          </a-modal>
        `,
        methods: {
          handleCancel() {
            console.log('ConfirmDialog handleCancel called');
            // 首先隐藏弹窗
            this.visible = false;
            // 然后执行reject回调，标记为取消
            this.reject({ 
              reason: '用户取消操作', 
              dialogId: this.dialogId,
              isCanceled: true
            });
            // 最后关闭弹窗
            DialogManager.destroyDialog(this.dialogId);
          },
          handleConfirm() {
            console.log('ConfirmDialog handleConfirm called');
            // 首先隐藏弹窗
            this.visible = false;
            // 然后执行resolve回调
            this.resolve({ confirmed: true, dialogId: this.dialogId });
            // 最后关闭弹窗
            DialogManager.destroyDialog(this.dialogId);
          },
          async openNestedConfirm() {
            // 在当前弹窗中打开另一个确认弹窗
            const [err, result] = await DialogManager.toOpenDialog(
              'ConfirmDialog', 
              { 
                message: '这是内嵌的确认弹窗！',
                title: '内嵌确认',
                dialogKey: 'nested_confirm_' + this.dialogId,
                parentDialogId: this.dialogId
              }
            );
            
            if (!err) {
              console.log('内嵌确认弹窗确认：', result.data);
              this.$message.success('内嵌确认弹窗已确认');
            }
          }
        }
      },
      
      // 提示弹窗
      InfoDialog: {
        props: {
          message: {
            type: String,
            default: '提示信息'
          },
          visible: {
            type: Boolean,
            default: false
          },
          dialogId: {
            type: String,
            default: ''
          },
          resolve: {
            type: Function,
            required: true
          },
          reject: {
            type: Function,
            required: true
          }
        },
        template: `
          <a-modal
            title="提示"
            :visible="visible"
            :maskClosable="false"
            :closable="true"
            width="300px"
            @cancel="handleCancel"
            @ok="handleConfirm"
          >
            <div style="color: #666; text-align: center;">
              <a-icon type="info-circle" style="font-size: 24px; color: #1890ff; margin-right: 8px;" />
              {{ message }}
            </div>
            <div style="margin-top: 10px; text-align: center;">
              <a-button type="primary" size="small" @click="openNestedInfo">打开内嵌提示弹窗</a-button>
            </div>
          </a-modal>
        `,
        methods: {
          handleCancel() {
            console.log('InfoDialog handleCancel called');
            // 首先隐藏弹窗
            this.visible = false;
            // 然后执行reject回调，标记为取消
            this.reject({ 
              reason: '用户关闭提示弹窗', 
              dialogId: this.dialogId,
              isCanceled: true
            });
            // 最后关闭弹窗
            DialogManager.destroyDialog(this.dialogId);
          },
          handleConfirm() {
            console.log('InfoDialog handleConfirm called');
            // 首先隐藏弹窗
            this.visible = false;
            // 然后执行resolve回调
            this.resolve({ confirmed: true, dialogId: this.dialogId });
            // 最后关闭弹窗
            DialogManager.destroyDialog(this.dialogId);
          },
          async openNestedInfo() {
            // 在当前弹窗中打开另一个提示弹窗
            const [err, result] = await DialogManager.toOpenDialog(
              'InfoDialog', 
              { 
                message: '这是内嵌的提示弹窗！',
                title: '内嵌提示',
                dialogKey: 'nested_info_' + this.dialogId,
                parentDialogId: this.dialogId
              }
            );
            
            if (!err) {
              console.log('内嵌提示弹窗确认：', result.data);
              this.$message.success('内嵌提示弹窗已确认');
            }
          }
        }
      },
      
      // 内嵌弹窗示例
      NestedDialog: {
        props: {
          title: {
            type: String,
            default: '内嵌弹窗'
          },
          visible: {
            type: Boolean,
            default: false
          },
          dialogId: {
            type: String,
            default: ''
          },
          parentDialogId: {
            type: String,
            default: ''
          },
          resolve: {
            type: Function,
            required: true
          },
          reject: {
            type: Function,
            required: true
          }
        },
        template: `
          <a-modal
            :title="title"
            :visible="visible"
            :maskClosable="false"
            :closable="true"
            width="350px"
            @cancel="handleCancel"
            @ok="handleConfirm"
          >
            <div>这是内嵌弹窗（ID：{{dialogId}}）</div>
            <div>父弹窗ID：{{parentDialogId}}</div>
            <a-input 
              v-model="inputValue" 
              placeholder="内嵌弹窗输入" 
              style="margin-top: 10px;"
            />
          </a-modal>
        `,
        data() {
          return {
            inputValue: ''
          };
        },
        methods: {
          handleCancel() {
            console.log('NestedDialog handleCancel called');
            // 首先隐藏弹窗
            this.visible = false;
            // 然后执行reject回调，标记为取消
            this.reject({ 
              reason: '内嵌弹窗被取消', 
              dialogId: this.dialogId,
              parentDialogId: this.parentDialogId,
              isCanceled: true
            });
            // 最后关闭弹窗
            DialogManager.destroyDialog(this.dialogId);
          },
          handleConfirm() {
            console.log('NestedDialog handleConfirm called');
            // 首先隐藏弹窗
            this.visible = false;
            // 然后执行resolve回调
            this.resolve({ 
              inputValue: this.inputValue, 
              dialogId: this.dialogId,
              parentDialogId: this.parentDialogId
            });
            // 最后关闭弹窗
            DialogManager.destroyDialog(this.dialogId);
          }
        }
      }
    };

    // ========== 弹窗管理器核心实现（内嵌弹框 + 隐藏/销毁分离） ==========
    const DialogManager = {
      // 存储弹窗实例（包含隐藏状态）
      dialogs: new Map(),
      // 缓存组件构造器，避免重复创建
      constructorCache: new Map(),
      // 注册的全局组件映射
      registeredComponents: GlobalDialogComponents,
      // 生成唯一ID
      generateId() {
        return `dialog_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
      },

      // 获取组件（支持对象和字符串组件名）
      getComponent(componentOrName) {
        if (typeof componentOrName === 'string') {
          // 如果是字符串，从注册的全局组件中查找
          if (this.registeredComponents[componentOrName]) {
            return this.registeredComponents[componentOrName];
          } else {
            throw new Error(`未找到名为 "${componentOrName}" 的弹窗组件`);
          }
        } else if (typeof componentOrName === 'object' && componentOrName.template) {
          // 如果是组件对象，直接返回
          return componentOrName;
        } else {
          throw new Error('组件参数必须是组件对象或注册的组件名称');
        }
      },

      // 打开弹窗（原版：返回Promise）
      openDialog(componentOrName, config = {}) {
        // 解析组件
        const component = this.getComponent(componentOrName);
        
        // 从config中提取dialogKey和其他props
        const { dialogKey, ...props } = config;
        
        // 防重复打开：如果指定了key且已存在，则返回现有弹窗的Promise
        if (dialogKey && this.dialogs.has(dialogKey)) {
          const existingDialog = this.dialogs.get(dialogKey);
          console.warn(`弹窗[${dialogKey}]已打开，避免重复创建`);
          
          // 如果弹窗被隐藏了，重新显示它
          if (existingDialog.hidden) {
            this.showDialog(dialogKey);
          }
          
          return existingDialog.promise;
        }

        return new Promise((resolve, reject) => {
          const dialogId = dialogKey || this.generateId();
          // 缓存构造器，提升性能
          let DialogConstructor = this.constructorCache.get(component);
          if (!DialogConstructor) {
            DialogConstructor = Vue.extend(component);
            this.constructorCache.set(component, DialogConstructor);
          }

          // 初始化组件实例
          const dialogInstance = new DialogConstructor({
            el: document.createElement('div'),
            propsData: {
              ...props,
              dialogId,
              resolve: (data) => {
                console.log('Dialog resolved:', data);
                resolve({ data, dialogId });
                // 移除已完成的弹窗
                this.dialogs.delete(dialogId);
              },
              reject: (data) => {
                console.log('Dialog rejected:', data);
                reject(data);
                // 移除已取消的弹窗
                this.dialogs.delete(dialogId);
              }
            }
          });
          
          // 挂载弹窗到页面
          this.mountDialog(dialogInstance);
          
          // 存储实例和对应的Promise（包含隐藏状态）
          this.dialogs.set(dialogId, {
            instance: dialogInstance,
            promise: Promise.resolve({ dialogId }),
            title: props.title || component.name || '未知弹窗',
            hidden: false, // 初始状态为非隐藏
            type: 'normal' // 弹窗类型
          });
        });
      },

      // Await-to-js风格的打开弹窗方法
      async toOpenDialog(componentOrName, config = {}) {
        try {
          const result = await this.openDialog(componentOrName, config);
          return [null, result]; // [error, result]
        } catch (error) {
          // 如果是用户取消，仍然返回错误，但标记为取消
          if (error.isCanceled) {
            return [error, null]; // [cancellation, null]
          }
          // 如果是其他错误，返回错误对象
          return [error, null]; // [error, null]
        }
      },

      // Await-to-js风格的Pubsub打开弹窗方法
      async toPubsubOpenDialog(componentOrName, config = {}) {
        try {
          const result = await this.pubsubOpenDialog(componentOrName, config);
          return [null, result]; // [error, result]
        } catch (error) {
          // 如果是用户取消，仍然返回错误，但标记为取消
          if (error.isCanceled) {
            return [error, null]; // [cancellation, null]
          }
          // 如果是其他错误，返回错误对象
          return [error, null]; // [error, null]
        }
      },

      // 显示弹窗
      showDialog(dialogId) {
        const dialogItem = this.dialogs.get(dialogId);
        if (!dialogItem) {
          console.warn('未找到要显示的弹窗:', dialogId);
          return false;
        }
        
        if (dialogItem.instance && !dialogItem.hidden) {
          console.log('弹窗已经是显示状态:', dialogId);
          return true;
        }
        
        // 设置弹窗可见
        dialogItem.instance.visible = true;
        dialogItem.hidden = false;
        console.log('弹窗已显示:', dialogId);
        return true;
      },

      // 隐藏弹窗（仅隐藏，不销毁实例）
      hideDialog(dialogId) {
        const dialogItem = this.dialogs.get(dialogId);
        if (!dialogItem) {
          console.warn('未找到要隐藏的弹窗:', dialogId);
          return false;
        }
        
        if (dialogItem.instance && dialogItem.hidden) {
          console.log('弹窗已经是隐藏状态:', dialogId);
          return true;
        }
        
        // 隐藏弹窗
        dialogItem.instance.visible = false;
        dialogItem.hidden = true;
        console.log('弹窗已隐藏:', dialogId);
        return true;
      },

      // 销毁弹窗（完全销毁，释放内存）
      destroyDialog(dialogId) {
        const dialogItem = this.dialogs.get(dialogId);
        if (!dialogItem) {
          console.warn('未找到要销毁的弹窗:', dialogId);
          return false;
        }
        
        const { instance } = dialogItem;
        
        // 确保弹窗可见状态被设置为false
        if (instance.visible) {
          instance.visible = false;
        }
        
        // 优化：动态获取动画时长（兼容不同组件的动画）
        const transitionDuration = this.getTransitionDuration(instance.$el);
        const delay = transitionDuration || 300;

        // 延迟卸载，适配动画
        setTimeout(() => {
          try {
            // 安全移除DOM：增加父节点校验
            if (instance.$el && instance.$el.parentNode) {
              document.body.removeChild(instance.$el);
            }
            // 销毁实例前解绑所有事件
            instance.$off();
            // 销毁组件实例
            instance.$destroy();
            // 清理数据引用
            for (const key in instance) {
              if (instance.hasOwnProperty(key) && key !== '$options') {
                instance[key] = null;
              }
            }
          } catch (e) {
            console.error('销毁弹窗时出错:', e);
          } finally {
            // 确保从Map中移除
            this.dialogs.delete(dialogId);
            console.log('弹窗已完全销毁:', dialogId);
          }
        }, delay);
        
        return true;
      },

      // 关闭弹窗（隐藏+销毁的组合操作）
      closeDialog(dialogId) {
        this.hideDialog(dialogId);
        this.destroyDialog(dialogId);
      },

      // 关闭所有弹窗
      closeAllDialogs() {
        // 转换为数组避免遍历过程中Map结构变化
        const dialogIds = Array.from(this.dialogs.keys());
        console.log('准备关闭所有弹窗:', dialogIds);
        dialogIds.forEach(id => this.destroyDialog(id));
        console.log('已关闭所有弹窗');
      },

      // 检查弹窗是否存在
      hasDialog(dialogIdOrInstance) {
        if (typeof dialogIdOrInstance === 'string') {
          return this.dialogs.has(dialogIdOrInstance);
        }
        for (const item of this.dialogs.values()) {
          if (item.instance === dialogIdOrInstance) return true;
        }
        return false;
      },

      // 挂载弹窗到body
      mountDialog(dialogInstance) {
        if (!dialogInstance.$el || dialogInstance.$el.parentNode) return;
        document.body.appendChild(dialogInstance.$el);
        // 确保DOM渲染完成后再显示
        Vue.nextTick(() => {
          dialogInstance.visible = true;
        });
      },

      // 动态获取元素的过渡动画时长
      getTransitionDuration(el) {
        if (!el) return 0;
        const computedStyle = window.getComputedStyle(el);
        const transitionDuration = computedStyle.transitionDuration || '0s';
        return parseFloat(transitionDuration) * 1000;
      },

      // ========== 统一的 Pubsub API ==========
      // 通过Pubsub打开弹窗（统一API）
      pubsubOpenDialog(componentOrName, config = {}) {
        return PubSub.publish('dialog/open', { componentOrName, config });
      },
      
      // 通过Pubsub关闭弹窗（统一API）
      pubsubCloseDialog(dialogId) {
        return PubSub.publish('dialog/close', dialogId);
      },
      
      // 通过Pubsub隐藏弹窗（统一API）
      pubsubHideDialog(dialogId) {
        return PubSub.publish('dialog/hide', dialogId);
      },
      
      // 通过Pubsub销毁弹窗（统一API）
      pubsubDestroyDialog(dialogId) {
        return PubSub.publish('dialog/destroy', dialogId);
      },
      
      // 通过Pubsub关闭所有弹窗（统一API）
      pubsubCloseAllDialogs() {
        return PubSub.publish('dialog/closeAll');
      },

      // 获取当前打开的弹窗列表
      getOpenDialogs() {
        const dialogs = [];
        for (const [id, item] of this.dialogs.entries()) {
          dialogs.push({
            id,
            title: item.title,
            instance: item.instance,
            hidden: item.hidden,
            type: item.type
          });
        }
        return dialogs;
      },

      // 初始化Pubsub订阅
      initPubsub() {
        // 订阅打开弹窗的事件
        PubSub.subscribe('dialog/open', (msg, { componentOrName, config }) => {
          return this.openDialog(componentOrName, config);
        });
        
        // 订阅关闭弹窗的事件
        PubSub.subscribe('dialog/close', (msg, dialogId) => {
          this.closeDialog(dialogId);
        });
        
        // 订阅隐藏弹窗的事件
        PubSub.subscribe('dialog/hide', (msg, dialogId) => {
          this.hideDialog(dialogId);
        });
        
        // 订阅销毁弹窗的事件
        PubSub.subscribe('dialog/destroy', (msg, dialogId) => {
          this.destroyDialog(dialogId);
        });
        
        // 订阅关闭所有弹窗的事件
        PubSub.subscribe('dialog/closeAll', () => {
          this.closeAllDialogs();
        });
        
        console.log('弹窗管理器Pubsub订阅已初始化');
      }
    };

    // 初始化Pubsub订阅
    DialogManager.initPubsub();

    // ========== 主 Vue 实例 ==========
    new Vue({
      el: '#app',
      data() {
        return {
          openDialogs: []
        };
      },
      mounted() {
        // 定期更新打开的弹窗列表
        setInterval(() => {
          this.updateOpenDialogs();
        }, 1000); // 每秒更新一次
      },
      methods: {
        updateOpenDialogs() {
          this.openDialogs = DialogManager.getOpenDialogs();
        },
        
        // 常规方式打开弹窗（使用组件对象）
        async openCustomDialog() {
          const [err, result] = await DialogManager.toOpenDialog(
            GlobalDialogComponents.CustomDialog,
            { 
              title: 'AntV 自定义弹窗',
              dialogKey: 'custom_dialog' // 包含在props中，防重复打开
            }
          );

          if (err) {
            // 弹窗被取消或发生错误
            if (err.isCanceled) {
              console.log('弹窗被取消：', err);
              this.$message.info('弹窗已取消');
            } else {
              // 发生了代码错误
              console.error('弹窗打开失败：', err);
              this.$message.error('弹窗打开失败');
            }
          } else {
            // 弹窗成功确认
            console.log('弹窗确认返回数据：', result.data);
            this.$message.success(`你输入的内容是：${result.data.inputValue}（弹窗ID：${result.dialogId}）`);
          }
        },

        // 常规方式打开确认弹窗（使用组件对象）
        async openConfirmDialog() {
          const [err, result] = await DialogManager.toOpenDialog(
            GlobalDialogComponents.ConfirmDialog,
            { 
              message: '确定要删除这条数据吗？',
              dialogKey: 'confirm_dialog' // 包含在props中，防重复打开
            }
          );

          if (err) {
            if (err.isCanceled) {
              console.log('确认弹窗被取消：', err);
              this.$message.warning('删除操作已取消');
            } else {
              console.error('确认弹窗打开失败：', err);
              this.$message.error('确认弹窗打开失败');
            }
          } else {
            this.$message.success('删除操作已确认');
          }
        },

        // 通过组件名打开弹窗（新功能）
        async openByComponentName() {
          const [err, result] = await DialogManager.toOpenDialog(
            'CustomDialog', // 使用字符串组件名
            { 
              title: '通过组件名打开的弹窗',
              dialogKey: 'component_name_dialog' // 包含在props中，防重复打开
            }
          );

          if (err) {
            if (err.isCanceled) {
              console.log('组件名弹窗被取消：', err);
              this.$message.info('组件名弹窗已取消');
            } else {
              console.error('组件名弹窗打开失败：', err);
              this.$message.error('组件名弹窗打开失败');
            }
          } else {
            console.log('组件名弹窗确认返回数据：', result.data);
            this.$message.success(`通过组件名打开的弹窗输入内容：${result.data.inputValue}（弹窗ID：${result.dialogId}）`);
          }
        },

        // 通过Pubsub打开弹窗（统一API）
        async openByPubsub() {
          const [err, result] = await DialogManager.toPubsubOpenDialog(
            'InfoDialog', 
            {
              message: '这是通过统一API的Pubsub和组件名打开的提示弹窗！',
              dialogKey: 'pubsub_component_name_dialog' // 包含在props中
            }
          );

          if (err) {
            if (err.isCanceled) {
              console.log('Pubsub弹窗被取消：', err);
              this.$message.info('Pubsub弹窗已取消');
            } else {
              console.error('Pubsub弹窗打开失败：', err);
              this.$message.error('Pubsub弹窗打开失败');
            }
          } else {
            console.log('Pubsub弹窗确认返回数据：', result.data);
            this.$message.success(`Pubsub弹窗返回：已确认（弹窗ID：${result.dialogId}）`);
          }
        },

        // 关闭所有弹窗
        closeAllDialogs() {
          DialogManager.closeAllDialogs();
          this.$message.info('所有弹窗已关闭');
        }
      },
      // 页面销毁时关闭所有弹窗，防止内存泄漏
      beforeDestroy() {
        DialogManager.closeAllDialogs();
      }
    });

    // 初始化语法高亮
    document.addEventListener('DOMContentLoaded', function() {
      Prism.highlightAll();
    });
  </script>

  <style>
    body {
      height: auto;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    
    .code-examples {
      margin-top: 30px;
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #eee;
    }
    
    .example-section {
      margin-bottom: 25px;
    }
    
    .example-section h4 {
      margin-bottom: 10px;
      color: #333;
    }
    
    pre {
      margin: 0;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</body>
</html>